# Annotorious SegmentAnything Plugin

A fully browser-based smart polygon selection tool for Annotorious based on the [sam2-hiera-tiny](https://huggingface.co/g-ronimo/sam2-tiny) SegmentAnything model. The basic approach is inspired by this [blog post](https://medium.com/@geronimo7/in-browser-image-segmentation-with-segment-anything-model-2-c72680170d92) and [demo code](https://github.com/geronimi73/next-sam). 

![Demo](/screenshot.gif "Demo screenshot")

> **Important:** this plugin only supports `@annotorious/openseadragon` at this time. Support for 
> plain (JPEG, PNG,...) images is not yet implemented. [Get in touch via the forum](https://github.com/orgs/annotorious/discussions) if you are interested in 
> using this with the `@annotorious/annotorious` or `@annotorious/react` packages.

## Installation

```
npm install @annotorious/plugin-segment-anything
```

## How to Use

To create annotations with the Annotorious SegmentAnything plugin:

- **Hover the mouse** over the image. The plugin will show segmentation mask previews generated by the SAM model in real-time.
- **Click** to select a segment and create a polygon annotation.
- Optionally, **refine** the polygon by indicating areas to add (click) or remove from the shape (`SHIFT` + click).

> **Note:** After panning or zooming the OpenSeadragon viewer, the tool will take some time to re-initialize. This delay is because the SAM model re-encodes the current viewport for segmentation.

## API

This plugin is designed to be **headless**: it provides the core segmentation logic, but expects implementers to build their own UI to interact with it.

### Lifecycle & Core Methods

- `init()`
  Starts the plugin initialization process. This includes downloading the ML model, which may take some time! (Note the model is cached in the browser. Download happens only once.)

- `start()`
  Activates the plugin and enables hover previews. If `init()` has not been called yet, it will be triggered now.

- `stop()`
  Deactivates the plugin, disabling segment mask previews.

- `reset()`
  Removes the current annotation and restarts the plugin.

- `restart()`
  Stops and then starts the plugin again, resetting internal state without deleting annotations.

- `setQueryMode(mode: 'add' | 'remove')`
  Switches the query mode programmatically. If set to `remove`, mouse clicks will identify areas to remove (even without holding `SHIFT`). 

- `destroy()`
  Destroys the plugin, cleaning up all resources and event listeners.

### Events

The plugin emits events to notify the host app about its internal state and activities, so you can provide a corresponding UI.


| Event               | Parameters                                                                            | Description                                         |
| ------------------- | ------------------------------------------------------------------------------------- | --------------------------------------------------- |
| `downloadStart`     | —                                                                                     | Model download has started.                         |
| `downloadProgress`  | `(progress: { loaded: number; total?: number; complete?: boolean })`                  | Provides progress updates during model download.    |
| `initialized`       | —                                                                                     | Plugin and model initialization complete.           |
| `initError`         | `(error: any)`                                                                        | Initialization failed with an error.                |
| `encodingStart`     | —                                                                                     | The plugin started encoding the current viewport.   |
| `encodingFinished`  | —                                                                                     | Viewport encoding finished and preview can proceed. |
| `animationStart`    | —                                                                                     | User started panning or zooming the image.          |
| `animationFinished` | —                                                                                     | User finished panning or zooming the image.         |
| `createAnnotation`  | `(annotation: ImageAnnotation, prompt: SAM2DecoderPrompt)`                            | A new annotation was created based on SAM output.   |
| `updateAnnotation`  | `(annotation: ImageAnnotation, previous: ImageAnnotation, prompt: SAM2DecoderPrompt)` | An existing annotation was updated/refined.         |
| `deleteAnnotation`  | `(annotation: ImageAnnotation)`                                                       | An annotation was deleted (e.g., on reset).         |

## Usage Example

```ts
import OpenSeadragon from 'openseadragon';
import { createOSDAnnotator } from '@annotorious/openseadragon';
import { mountOpenSeadragonPlugin } from '@annotorious/plugin-segment-anything/openseadragon';

import '@annotorious/openseadragon/annotorious-openseadragon.css';

const viewer = OpenSeadragon({
  /** init your viewer **/
});

const anno = createOSDAnnotator(viewer, { /* options */ });

// Initialize the plugin
const plugin = mountOpenSeadragonPlugin(anno);

// This will start initializing the plugin, incl.
// download of the model (this may take a while).
plugin.init();

plugin.on('downloadStart', () => {
  console.log('downloading the model - this may take a while');
});

plugin.on('downloadProgress', progress => {
  if (progress.complete)
    console.log('downloading complete');
});

plugin.on('initialized', () => {
  console.log('plugin ready');
});

plugin.on('encodingStart', () => {
  console.log('busy - encoding viewport');
});

plugin.on('encodingFinished', () => {
  console.log('ready - click to create annotation!');
});
```
